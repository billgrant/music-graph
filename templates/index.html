{% extends "base.html" %}

{% block title %}Music Genre Graph{% endblock %}

{% block extra_head %}
<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
{% endblock %}

{% block content %}
<h1>Music Genre Graph</h1>
<p class="subtitle">Exploring connections between genres and bands</p>

<!-- This is the container where the graph will render -->
<div id="network-graph"></div>
{% endblock %}

{% block extra_scripts %}
<script type="text/javascript">
    // Genre and band nodes
    var nodes = new vis.DataSet([
        // Add genres - sized by hierarchy (root=large, intermediate=medium, leaf=small)
        {% for genre in genres %}
    {
        id: '{{ genre.id }}',
        label: '{{ genre.name }}',
        shape: 'dot',
        size: {% if genre.type == 'root' %}40{% elif genre.type == 'intermediate' %}25{% else %}15{% endif %},
        color: '#4CAF50',
        group: 'genre'
    },
    {% endfor %}
    // Add bands (hidden by default)
    {% for band in bands %}
    {
        id: '{{ band.id }}',
        label: '{{ band.name }}',
        shape: 'text',
        font: {
            color: '#ffffff',
            size: 14
        },
        hidden: true,
        group: 'band',
        parentGenre: '{{ band.primary_genre_id }}'
    }{% if not loop.last %},{% endif %}
    {% endfor %}
]);

    // Entity data for detail panel (generic structure)
    var entityData = {
        bands: {
            {% for band in bands %}
            '{{ band.id }}': {
                type: 'band',
                name: '{{ band.name }}',
                fields: [
                    {
                        label: 'Primary Genre',
                        value: '{{ band.primary_genre.name }}',
                        link: '{{ band.primary_genre_id }}'
                    },
                    {
                        label: 'All Genres',
                        values: [{% for g in band.genres %}'{{ g.name }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                        links: [{% for g in band.genres %}'{{ g.id }}'{% if not loop.last %}, {% endif %}{% endfor %}]
                    }
                ]
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        },
        genres: {
            {% for genre in genres %}
            '{{ genre.id }}': {
                type: 'genre',
                name: '{{ genre.name }}',
                fields: [
                    {
                        label: 'Type',
                        value: '{{ genre.type }}',
                        badge: true
                    },
                    {% if genre.parent %}
                    {
                        label: 'Primary Parent',
                        value: '{{ genre.parent.name }}',
                        link: '{{ genre.parent_id }}'
                    },
                    {% endif %}
                    {% if genre.parent_genres %}
                    {
                        label: 'All Parents',
                        values: [{% for p in genre.parent_genres %}'{{ p.name }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                        links: [{% for p in genre.parent_genres %}'{{ p.id }}'{% if not loop.last %}, {% endif %}{% endfor %}]
                    },
                    {% endif %}
                    {
                        label: 'Child Genres',
                        values: [{% for c in genre.children %}'{{ c.name }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                        links: [{% for c in genre.children %}'{{ c.id }}'{% if not loop.last %}, {% endif %}{% endfor %}]
                    },
                    {
                        label: 'Bands',
                        values: [{% for b in genre.all_bands %}'{{ b.name }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                        links: [{% for b in genre.all_bands %}'{{ b.id }}'{% if not loop.last %}, {% endif %}{% endfor %}]
                    }
                ]
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        }
    };

    // Connections between genres and from bands to genres
    var edges = new vis.DataSet([
        // Genre to genre connections
        {% for from_id, to_id in connections %}
    { from: '{{ from_id }}', to: '{{ to_id }}' },
    {% endfor %}
    // Band to genre connections (primary only)
    {% for band in bands %}
    { from: '{{ band.id }}', to: '{{ band.primary_genre_id }}' }{% if not loop.last %},{% endif %}
    {% endfor %}
]);
    // Container element
    var container = document.getElementById('network-graph');

    // Graph data
    var data = {
        nodes: nodes,
        edges: edges
    };

    // Configuration options (like your network diagram layout settings)
    var options = {
        nodes: {
            shape: 'dot',
            font: {
                size: 14,
                color: '#ffffff'
            },
            borderWidth: 2,
            borderWidthSelected: 4,
            scaling: {
                label: {
                    enabled: false
                }
            }
        },
        edges: {
            width: 2,
            color: {
                color: '#848484',
                highlight: '#4CAF50'
            },
            smooth: {
                type: 'continuous'
            }
        },
        physics: {
            enabled: true,
            stabilization: {
                iterations: 200
            }
        }
    };

    // Create the network (this is like rendering your network topology)
    var network = new vis.Network(container, data, options);

    // Track which genres are expanded
    var expandedGenres = new Set();

    // Add click event listener
    network.on("click", function (params) {
        if (params.nodes.length > 0) {
            var clickedNodeId = params.nodes[0];
            var clickedNode = nodes.get(clickedNodeId);

            // Check if it's a genre (not a band)
            if (clickedNode.group === 'genre') {
                toggleGenre(clickedNodeId);
                showGenreDetails(clickedNodeId);  // Also show genre details
            } else if (clickedNode.group === 'band') {
                showBandDetails(clickedNodeId);
            }
        }
    });

    // Function to expand/collapse a genre
    function toggleGenre(genreId) {
        if (expandedGenres.has(genreId)) {
            // Collapse: hide bands for this genre
            expandedGenres.delete(genreId);
            hideBandsForGenre(genreId);
        } else {
            // Expand: show bands for this genre
            expandedGenres.add(genreId);
            showBandsForGenre(genreId);
        }
    }

    // Show all bands that belong to a genre
    function showBandsForGenre(genreId) {
        nodes.forEach(function (node) {
            if (node.group === 'band' && node.parentGenre === genreId) {
                nodes.update({ id: node.id, hidden: false });
            }
        });
    }

    // Hide all bands that belong to a genre
    function hideBandsForGenre(genreId) {
        nodes.forEach(function (node) {
            if (node.group === 'band' && node.parentGenre === genreId) {
                nodes.update({ id: node.id, hidden: true });
            }
        });
    }

    // === Detail Panel Functions ===

    // Generic function to show detail panel for any entity type
    function showDetailPanel(entityType, entityId) {
        // Look up entity data: entityType is 'band' or 'genre'
        // entityData.bands['pantera'] or entityData.genres['death-metal']
        var entityCollection = entityData[entityType + 's'];  // 'band' -> 'bands'
        var entity = entityCollection[entityId];

        if (!entity) {
            console.error('Entity not found:', entityType, entityId);
            return;
        }

        // Build the HTML content
        var html = '<h2>' + entity.name + '</h2>';

        // Loop through each field and render based on its type
        entity.fields.forEach(function(field) {
            // Skip empty arrays (e.g., genre with no bands)
            if (field.values && field.values.length === 0) {
                return;  // Skip this field
            }

            html += '<div class="field">';
            html += '<div class="field-label">' + field.label + '</div>';
            html += '<div class="field-value">';

            if (field.badge) {
                // Render as a badge (like genre type: root/intermediate/leaf)
                html += '<span class="badge badge-' + field.value + '">' + field.value + '</span>';

            } else if (field.url) {
                // External link (like Wikipedia)
                html += '<a href="' + field.url + '" target="_blank">' + field.value + '</a>';

            } else if (field.values && field.links) {
                // List of clickable items (like all genres for a band)
                field.values.forEach(function(val, i) {
                    html += '<a href="#" onclick="focusAndShowPanel(\'' + field.links[i] + '\'); return false;">' + val + '</a>';
                });

            } else if (field.link) {
                // Single clickable item (like primary genre)
                html += '<a href="#" onclick="focusAndShowPanel(\'' + field.link + '\'); return false;">' + field.value + '</a>';

            } else {
                // Plain text
                html += field.value;
            }

            html += '</div></div>';
        });

        // Insert HTML into panel and show it
        document.getElementById('panel-content').innerHTML = html;
        document.getElementById('detail-panel').classList.add('open');
    }

    // Close the detail panel
    function closeDetailPanel() {
        document.getElementById('detail-panel').classList.remove('open');
    }

    // Focus graph on a node and show its details
    function focusAndShowPanel(nodeId) {
        // Find what type of entity this is
        var node = nodes.get(nodeId);
        if (node) {
            // Focus and select the node in the graph
            network.focus(nodeId, { scale: 1.2, animation: true });
            network.selectNodes([nodeId]);

            // Show its detail panel
            showDetailPanel(node.group, nodeId);  // group is 'band' or 'genre'
        }
    }

    // Wrapper functions for click handlers
    function showBandDetails(bandId) {
        showDetailPanel('band', bandId);
    }

    function showGenreDetails(genreId) {
        showDetailPanel('genre', genreId);
    }
</script>
{% endblock %}
