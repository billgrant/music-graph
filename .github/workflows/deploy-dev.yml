name: Deploy to Dev

on:
  push:
    branches: [ main ]
    paths:
      - 'app.py'
      - 'models.py'
      - 'config.py'
      - 'init_db.py'
      - 'make_admin.py'
      - 'migrate_*.py'
      - 'entrypoint.sh'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'templates/**'
      - 'static/**'
      - 'tests/**'
      - '.github/workflows/ci.yml'
      - '.github/workflows/deploy-dev.yml'
      - 'docker-compose.dev.yml'
  workflow_run:
    workflows: ["Terraform Apply"]
    types: [completed]
    branches: [main]
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  # Check if we should run (skip if TF failed or no app changes)
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Checkout code
        if: github.event_name == 'workflow_run'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for merge-base

      - name: Check if should run
        id: check
        run: |
          # If triggered by workflow_run (after Terraform Apply)
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            # Check if Terraform succeeded
            if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
              echo "Terraform Apply failed, skipping deploy"
              echo "should_run=false" >> $GITHUB_OUTPUT
              exit 0
            fi

            # For merge commits, HEAD~1 only gets one parent
            # Use merge-base to find common ancestor with main branch
            # Then diff against that to see all changes in the merge
            if git rev-parse HEAD^2 >/dev/null 2>&1; then
              echo "Detected merge commit"
              # This is a merge commit - get changes between merge-base and HEAD
              MERGE_BASE=$(git merge-base HEAD^1 HEAD^2)
              CHANGED_FILES=$(git diff --name-only $MERGE_BASE HEAD 2>/dev/null || echo "")
            else
              echo "Detected regular commit"
              # Regular commit - use HEAD~1
              CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
            fi

            echo "Changed files:"
            echo "$CHANGED_FILES"

            # Check if any app files changed
            APP_PATTERNS="app.py|models.py|config.py|init_db.py|make_admin.py|migrate_.*\.py|entrypoint.sh|requirements.txt|Dockerfile|templates/|static/|tests/"

            if echo "$CHANGED_FILES" | grep -qE "$APP_PATTERNS"; then
              echo "App files changed, proceeding with deploy"
              echo "should_run=true" >> $GITHUB_OUTPUT
            else
              echo "No app files changed, skipping deploy"
              echo "should_run=false" >> $GITHUB_OUTPUT
            fi
            exit 0
          fi

          # For push and workflow_dispatch, always run
          echo "should_run=true" >> $GITHUB_OUTPUT

  # Run tests first - reuse existing CI workflow
  test:
    needs: [check-trigger]
    if: needs.check-trigger.outputs.should_run == 'true'
    uses: ./.github/workflows/ci.yml

  build-and-push:
    runs-on: ubuntu-latest
    needs: [check-trigger, test]
    if: needs.check-trigger.outputs.should_run == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Authenticate to Google Cloud
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for GCR
      run: gcloud auth configure-docker

    # Build the Docker image
    - name: Build Docker image
      run: |
        docker build -t music-graph:latest .

    # Tag with dev- prefix and dev-latest
    - name: Tag image
      run: |
        IMAGE_NAME="gcr.io/${{ secrets.GCP_PROJECT_ID }}/music-graph"
        GIT_SHA="${{ github.sha }}"

        # Tag with dev- prefix + SHA for traceability
        docker tag music-graph:latest ${IMAGE_NAME}:dev-${GIT_SHA}
        # Tag with 'dev-latest' for dev environment
        docker tag music-graph:latest ${IMAGE_NAME}:dev-latest

    # Push to GCR
    - name: Push to GCR
      run: |
        IMAGE_NAME="gcr.io/${{ secrets.GCP_PROJECT_ID }}/music-graph"
        docker push ${IMAGE_NAME}:dev-${{ github.sha }}
        docker push ${IMAGE_NAME}:dev-latest

  deploy-to-dev:
    runs-on: ubuntu-latest
    needs: [check-trigger, build-and-push]
    if: needs.check-trigger.outputs.should_run == 'true'

    steps:
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy music-graph-dev \
          --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/music-graph:dev-${{ github.sha }} \
          --region us-east1 \
          --quiet

        echo "=== Deployment Complete ==="
        echo "Deployed commit: ${{ github.sha }}"
        echo "Deployed by: ${{ github.actor }}"
