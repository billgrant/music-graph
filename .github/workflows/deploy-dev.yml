name: Deploy to Dev

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  # Run tests first - reuse existing CI workflow
  test:
    uses: ./.github/workflows/ci.yml

  build-and-push:
    runs-on: ubuntu-latest
    needs: [test]  # Only run if tests pass

    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Authenticate to Google Cloud
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for GCR
      run: gcloud auth configure-docker

    # Build the Docker image
    - name: Build Docker image
      run: |
        docker build -t music-graph:latest .

    # Tag with both 'latest' and git SHA
    - name: Tag image
      id: meta
      run: |
        IMAGE_NAME="gcr.io/${{ secrets.GCP_PROJECT_ID }}/music-graph"
        GIT_SHA="${{ github.sha }}"

        # Tag with SHA for traceability
        docker tag music-graph:latest ${IMAGE_NAME}:${GIT_SHA}
        # Tag with 'latest' for convenience
        docker tag music-graph:latest ${IMAGE_NAME}:latest

        echo "tags=${IMAGE_NAME}:${GIT_SHA}" >> $GITHUB_OUTPUT

    # Push to GCR
    - name: Push to GCR
      run: |
        IMAGE_NAME="gcr.io/${{ secrets.GCP_PROJECT_ID }}/music-graph"
        docker push ${IMAGE_NAME}:${{ github.sha }}
        docker push ${IMAGE_NAME}:latest

  deploy-to-dev:
    runs-on: ubuntu-latest
    needs: [build-and-push]

    steps:
    - name: Deploy to dev VM
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DEV_HOST }}
        username: ${{ secrets.DEV_USER }}
        key: ${{ secrets.DEV_SSH_PRIVATE_KEY }}
        script: |
          cd ~/music-graph

          # Authenticate gcloud using the VM's service account from metadata service
          SA_EMAIL=$(curl -s -H "Metadata-Flavor: Google" \
            http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email)
          gcloud config set account "$SA_EMAIL"

          # Configure Docker to use gcloud for GCR authentication
          gcloud auth configure-docker gcr.io --quiet

          # Pull the new image
          docker pull gcr.io/${{ secrets.GCP_PROJECT_ID }}/music-graph:latest

          # Stop and remove old containers to ensure clean state
          docker-compose -f docker-compose.dev.yml down

          # Start with new image
          docker-compose -f docker-compose.dev.yml up -d

          # Show deployment info
          echo "=== Deployment Complete ==="
          echo "Deployed commit: ${{ github.sha }}"
          echo "Deployed by: ${{ github.actor }}"
          echo ""
          docker-compose -f docker-compose.dev.yml ps
